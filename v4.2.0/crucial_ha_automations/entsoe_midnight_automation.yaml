alias: "ENTSO-E v420: Midnight Promote + NVS Load + HTTP Fallback"
description: >
  At midnight, attempt to promote tomorrow's NVS curve (tomorrow96 -> today96)
  into today's data and correctly populate sensors. If promotion fails (e.g., partial
  failure or invalid data), fall back to clearing and reloading from NVS. Finally,
  try HTTP as a last resort. Accurate notifications and retries ensure a reliable turnover.
triggers:
  - trigger: time
    at: "00:00:00"
conditions: []
actions:
  # 1. Attempt to promote tomorrow96 -> today96 from NVS using ESPHome API
  - action: esphome.entso_e_prices_promote_and_load_today_from_nvs
  - delay:
      seconds: 10

  # 2. Check if promotion was successful
  - choose:
      # Success Condition: NVS promotion is complete, valid data loaded
      - conditions:
          - condition: template
            value_template: >
              {% set status = states('sensor.entso_e_prices_price_update_status') %}
              {% set cur    = states('sensor.entso_e_prices_current_price_status') %}
              {% set nvs    = states('sensor.entso_e_prices_entso_e_today_nvs_status') | default('') %}
              {% set src    = states('sensor.entso_e_prices_entso_e_last_update_source') | default('') %}
              {{ status == 'SUCCESS' and cur == 'Valid' and src == 'NVS_promote'
                 and 'Promote FAILED' not in nvs and 'Load FAILED after promote' not in nvs }}
        sequence:
          # Clear tomorrowâ€™s data in RAM to reset properly
          - action: esphome.entso_e_prices_clear_tomorrow_prices

          # Notify success and resolution
          - action: persistent_notification.create
            data:
              title: ENTSO-E Midnight NVS Promote Success
              message: >
                Today's prices were promoted from tomorrow96 and loaded from NVS
                at midnight. Last update time: {{
                states('sensor.entso_e_prices_last_price_update_time') }}
              notification_id: entsoe_midnight_status

      # Fallback: Promotion failed (invalid data or partial promotion)
      - conditions:
          - condition: template
            value_template: >
              {% set status = states('sensor.entso_e_prices_price_update_status') %}
              {% set cur    = states('sensor.entso_e_prices_current_price_status') %}
              {% set src    = states('sensor.entso_e_prices_entso_e_last_update_source') | default('') %}
              {{ not (status == 'SUCCESS' and cur == 'Valid' and src == 'NVS_promote') }}
        sequence:
          # 2a. Clear in-memory today and tomorrow data
          - action: esphome.entso_e_prices_clear_today_prices
          - action: esphome.entso_e_prices_clear_tomorrow_prices

          # 2b. Try to reload today from NVS (today96) directly
          - action: esphome.entso_e_prices_load_today_from_nvs
          - delay:
              seconds: 20

          # 2c. Check if loading from today96 was successful
          - choose:
              # NVS today96 load successful
              - conditions:
                  - condition: template
                    value_template: >
                      {% set status = states('sensor.entso_e_prices_price_update_status') %}
                      {% set cur    = states('sensor.entso_e_prices_current_price_status') %}
                      {% set src    = states('sensor.entso_e_prices_entso_e_last_update_source') | default('') %}
                      {{ status == 'SUCCESS' and cur == 'Valid' and src == 'NVS_today96' }}
                sequence:
                  - action: persistent_notification.create
                    data:
                      title: ENTSO-E Midnight NVS (today96) Success
                      message: >
                        Today's prices were loaded from today96 NVS at midnight
                        after promote failed or was unavailable. Last update time: {{
                        states('sensor.entso_e_prices_last_price_update_time') }}
                      notification_id: entsoe_midnight_status

              # 2d. NVS load from today96 also failed, fallback to HTTP retries
              - conditions:
                  - condition: template
                    value_template: >
                      {% set status = states('sensor.entso_e_prices_price_update_status') %}
                      {% set cur    = states('sensor.entso_e_prices_current_price_status') %}
                      {% set src    = states('sensor.entso_e_prices_entso_e_last_update_source') | default('') %}
                      {{ not (status == 'SUCCESS' and cur == 'Valid' and src == 'NVS_today96') }}
                sequence:
                  # Delay before HTTP retry starts
                  - delay:
                      minutes: 1

                  # Retry HTTP up to 3 times (every 2 minutes)
                  - repeat:
                      while:
                        - condition: template
                          value_template: >
                            {% set status = states('sensor.entso_e_prices_price_update_status') %}
                            {% set cur    = states('sensor.entso_e_prices_current_price_status') %}
                            {% set src    = states('sensor.entso_e_prices_entso_e_last_update_source') | default('') %}
                            {{ repeat.index <= 3 and not (status == 'SUCCESS' and cur == 'Valid' and src == 'HTTP_today') }}
                      sequence:
                        - action: button.press
                          target:
                            entity_id: button.entso_e_prices_entso_e_force_update
                        - delay:
                            minutes: 2

                  # Final HTTP check result
                  - choose:
                      # HTTP successfully fetched today's prices
                      - conditions:
                          - condition: template
                            value_template: >
                              {% set status = states('sensor.entso_e_prices_price_update_status') %}
                              {% set cur    = states('sensor.entso_e_prices_current_price_status') %}
                              {% set src    = states('sensor.entso_e_prices_entso_e_last_update_source') | default('') %}
                              {{ status == 'SUCCESS' and cur == 'Valid' and src == 'HTTP_today' }}
                        sequence:
                          - action: persistent_notification.create
                            data:
                              title: ENTSO-E Midnight HTTP Success
                              message: >
                                Today's prices were fetched from HTTP after fallback retries.
                                Last update time: {{
                                states('sensor.entso_e_prices_last_price_update_time') }}
                              notification_id: entsoe_midnight_status

                      # HTTP retries also failed
                      - conditions:
                          - condition: template
                            value_template: >
                              {% set status = states('sensor.entso_e_prices_price_update_status') %}
                              {% set cur    = states('sensor.entso_e_prices_current_price_status') %}
                              {% set src    = states('sensor.entso_e_prices_entso_e_last_update_source') | default('') %}
                              {{ not (status == 'SUCCESS' and cur == 'Valid' and src == 'HTTP_today') }}
                        sequence:
                          - action: persistent_notification.create
                            data:
                              title: ENTSO-E Midnight ERROR
                              message: >
                                Failed to populate today's prices after NVS promote,
                                NVS load, and HTTP retries. Status: {{
                                states('sensor.entso_e_prices_price_update_status') }}.
                                Current slot status: {{
                                states('sensor.entso_e_prices_current_price_status') }}.
                                Last update source: {{
                                states('sensor.entso_e_prices_entso_e_last_update_source') }}.
                                Last update time (if any): {{
                                states('sensor.entso_e_prices_last_price_update_time') }}.
                              notification_id: entsoe_midnight_error
                          - action: notify.mobile_app_sm_s911b
                            data:
                              title: ENTSO-E Midnight ERROR
                              message: >
                                Failed to populate today's prices after NVS promote,
                                NVS load, and HTTP retries. Status: {{
                                states('sensor.entso_e_prices_price_update_status') }}.
                                Current slot status: {{
                                states('sensor.entso_e_prices_current_price_status') }}.
                                Last update source: {{
                                states('sensor.entso_e_prices_entso_e_last_update_source') }}.
                                Last update time (if any): {{
                                states('sensor.entso_e_prices_last_price_update_time') }}.
mode: single
