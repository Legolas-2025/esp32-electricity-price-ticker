alias: "ENTSO-E v420: Robust Next-Day HTTP Update (13:50â€“20:50)"
description: >
  Starts at 13:50 and presses the Force Next Day Update button to fetch
  tomorrow's prices. Retries automatically every 30 minutes until 20:50 if
  attempts fail. Stops retrying early on a successful update. Includes logging
  for additional diagnostics during retries.
triggers:
  - platform: time
    at: "13:50:00"
conditions: []
actions:
  # 1. Trigger the update button for tomorrow's prices
  - action: button.press
    target:
      entity_id: button.entso_e_test_entso_e_force_next_day_update

  # 2. Short delay to let the update attempt process
  - delay:
      minutes: 2

  # 3. Retry loop: Check status, retry every 30 minutes if necessary
  - repeat:
      while:
        # Continue attempts only if the next day status is not "SUCCESS/Valid"
        - condition: template
          value_template: >
            {{ not (states('sensor.entso_e_test_next_day_price_update_status')
            == 'SUCCESS' and
                     states('sensor.entso_e_test_next_day_current_price_status') == 'Valid') }}

        # Allow retries up until 20:50
        - condition: template
          value_template: >
            {% set now = now() %}
            {{ now.hour < 20 or (now.hour == 20 and now.minute <= 50) }}
      sequence:
        # Retry periodically every 30 minutes
        - delay:
            minutes: 30

        # Check again before the next retry
        - choose: 
            - conditions:
                - condition: template
                  value_template: >
                    {{ not (states('sensor.entso_e_test_next_day_price_update_status')
                    == 'SUCCESS' and
                             states('sensor.entso_e_test_next_day_current_price_status') == 'Valid') }}
              sequence:
                # Press the button to trigger another API call
                - action: button.press
                  target:
                    entity_id: button.entso_e_test_entso_e_force_next_day_update
                # Delay to process the update attempt
                - delay:
                    minutes: 2
                # Add diagnostics after each retry
                - action: persistent_notification.create
                  data:
                    title: ENTSO-E Next-Day Retry Attempt
                    message: >
                      Attempting to update tomorrow's prices. Retry index: {{
                      repeat.index }}. Current status: {{
                      states('sensor.entso_e_test_next_day_price_update_status') }}. Next day
                      price data: {{
                      states('sensor.entso_e_test_next_day_hourly_prices_json') }}.
                    notification_id: entsoe_next_day_update_retry

  # 4. Final check after retry loop
  - choose:
      # Success: Notify a successful update at some point during the retry period
      - conditions:
          - condition: template
            value_template: >
              {{ states('sensor.entso_e_test_next_day_price_update_status') == 'SUCCESS'
                 and states('sensor.entso_e_test_next_day_current_price_status') == 'Valid' }}
        sequence:
          - action: persistent_notification.create
            data:
              title: ENTSO-E Next-Day HTTP Success
              message: >
                Tomorrow's prices were updated successfully at some point
                between 13:50 and 20:50. Last tomorrow update time: {{
                states('sensor.entso_e_test_next_day_last_price_update_time') }}.
              notification_id: entsoe_1350_status

      # Failure: Notify if all retries fail
      - conditions:
          - condition: template
            value_template: >
              {{ not (states('sensor.entso_e_test_next_day_price_update_status')
              == 'SUCCESS' and
                       states('sensor.entso_e_test_next_day_current_price_status') == 'Valid') }}
        sequence:
          # Persistent error notification
          - action: persistent_notification.create
            data:
              title: ENTSO-E Next-Day ERROR (after extended retries)
              message: >
                Failed to populate tomorrow's prices between 13:50 and 20:50,
                even after repeated HTTP retries. Error status: {{
                states('sensor.entso_e_test_next_day_price_update_status') }}.
                Last next-day update time: {{
                states('sensor.entso_e_test_next_day_last_price_update_time') }}.
              notification_id: entsoe_1350_error

          # Mobile push notification for errors
          - action: notify.mobile_app_sm_s911b
            data:
              title: ENTSO-E Next-Day HTTP ERROR (after retries)
              message: >
                Failed to populate tomorrow's prices between 13:50 and 20:50.
                Error status: {{
                states('sensor.entso_e_test_next_day_price_update_status') }}.
                Last update attempt: {{
                states('sensor.entso_e_test_next_day_last_price_update_time') }}.
mode: single
